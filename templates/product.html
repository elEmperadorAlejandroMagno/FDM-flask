{% extends "index.html" %}

{% block main %}
  
  <div class="product-page-container">
    <div class="img-container">
      <img src="{{ url }}{{ product.images.split(',')[0] }}" alt="{{ product.title }}" class="main-image" data-main-img="{{ url }}{{ product.images.split(',')[0] }}">
      <div class="extraImgs">
        {% if product.images %}
          {% for img in product.images.split(',') %}
            <img src="{{ url }}{{ img }}" alt="{{ product.title }}" class="extra-image">
          {% endfor %}
        {% endif %}
      </div>
    </div>
    <div class="product-details" data-id="{{ product.id }}">
      <h3 class="title">{{ product.title }}</h3>
      <p class="price">{{ product.price | uru }}</p>
      <p class="description">{{ product.description }}</p>
      <p class="quantity">Cantidad</p>
      <input type="number" value="1" min="1" max="9">
      <button class="addBtn">Agregar al carrito</button>
    </div>
  </div>

{% endblock %}

{% block script %}

  <link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}">

  <script type="module">
    import { formatCurrency, parseCurrency, drawSubtotal, getCount, updateCart } from '../static/js/utils.js';
    import { Producto, Carrito } from '../static/js/cart.js';

    document.addEventListener('DOMContentLoaded', () => {

      const mainImg = document.querySelector('.img-container img');
      const extraImgs = document.querySelectorAll('.extra-image');
      
      if (extraImgs.length > 0) {
        extraImgs[0].classList.add('active');
        extraImgs.forEach(img => {
          img.addEventListener('mouseenter', () => {
            extraImgs.forEach(img => img.classList.remove('active'));
            mainImg.src = img.src;
            img.classList.add('active');
          });
          img.addEventListener('mouseleave', () => {
            mainImg.src = mainImg.getAttribute('data-main-img');
            img.classList.remove('active');
            extraImgs[0].classList.add('active');
          });
        });
      }

      // Obtengo los datos del producto y creo un nuevo producto con class Producto

      addToCartBtn.addEventListener('click', async () => {
        const productID = document.querySelector(".product-details").getAttribute("data-id");
        const response = await fetch(`/get/${productID}`);
        if (response.ok) {
          const data = await response.json();
          // Aquí puedes crear el producto y agregarlo al carrito
          let producto;
          if (data.type === 'salsa') {
            producto = new Salsa(data.id, data.title, data.price, 1);
          } else if (data.type === 'merch') {
            producto = new Merch(data.id, data.title, data.price, 1);
          } else {
            producto = new Producto(data.id, data.title, data.price, 1);
          }

          const cartCookie = document.cookie.split('; ').find(row => row.startsWith('cart='));
          const { products: cartProducts = [], cost: cartCost = 0, count: cartCount = 0 } = cartCookie ? JSON.parse(decodeURIComponent(cartCookie.split('=')[1])) : {};
          const carrito = new Carrito(cartProducts, cartCost, cartCount);
          try {
            carrito.addItem(producto);
          }
          catch(e) {
            console.log("Error al agregar un producto al carrito")
          }
          // El resto del código se ejecuta después de la respuesta exitosa
          document.querySelector('.cart-count').innerHTML = carrito.count;
          document.querySelector('.cart-modal').classList.add('open');
          document.querySelector('.flex-container').classList.add('opacity');
        } else {
          // Manejar error si la petición falla
          alert('No se pudo agregar el producto al carrito.');
          return;
        }
      })
    });
  </script>

{% endblock %}