{% extends "index.html" %}

{% block main %}
  
  <div class="product-page-container">
    <div class="img-container">
      <img src="{{ product.images[0] }}" alt="{{ product.title }}" class="main-image" data-main-img="{{ product.images[0] }}">
      <div class="extraImgs">
        {% if product.images %}
          {% for img in product.images %}
            <img src="{{ img }}" alt="{{ product.title }}" class="extra-image">
          {% endfor %}
        {% endif %}
      </div>
    </div>
    <div class="product-details" data-id="{{ product.id }}">
      <h3 class="title">{{ product.title }}</h3>
      <p class="price">{{ product.price | uru }}</p>
      <p class="description">{{ product.description }}</p>
      <p class="quantity">Cantidad</p>
      <input type="number" value="1" min="1" max="9">
      <button class="addBtn">Agregar al carrito</button>
    </div>
  </div>

{% endblock %}

{% block script %}

  <link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}">

  <script type="module">
    import { updateCart } from '../static/js/draw_component.js';
    import { Producto, Carrito } from '../static/js/cart.js';
    import { showLoading, hideLoading, showToast } from '../static/js/feedback.js';

    document.addEventListener('DOMContentLoaded', () => {

      const mainImg = document.querySelector('.img-container img');
      const extraImgs = document.querySelectorAll('.extra-image');
      
      if (extraImgs.length > 0) {
        extraImgs[0].classList.add('active');
        extraImgs.forEach(img => {
          img.addEventListener('mouseenter', () => {
            extraImgs.forEach(img => img.classList.remove('active'));
            mainImg.src = img.src;
            img.classList.add('active');
          });
          img.addEventListener('mouseleave', () => {
            mainImg.src = mainImg.getAttribute('data-main-img');
            img.classList.remove('active');
            extraImgs[0].classList.add('active');
          });
        });
      }

      const addBtn = document.querySelector('.addBtn');
      const qtyInput = document.querySelector('.product-details input[type="number"]');
      const productID = document.querySelector('.product-details')?.getAttribute('data-id');
      const URL = '{{ url }}';

      function syncWithServer(products) {
        return fetch('/cart-page', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cart: products })
        }).then(r => r.json());
      }

      if (addBtn && productID) {
        addBtn.addEventListener('click', async () => {
          showLoading();
          const response = await fetch(`/product/${productID}`);
          if (!response.ok) {
            hideLoading();
            showToast('No se pudo obtener el producto', 'error');
            return;
          }
          const result = await response.json();
          if (result.status !== 'success' || !result.product) {
            alert('Producto no encontrado.');
            return;
          }
          const p = result.product;
          const qty = Math.max(1, parseInt(qtyInput?.value || '1', 10) || 1);
          const image = p.images ? (URL + p.images.split(',')[0]) : null;
          const item = new Producto(p.id, p.title, p.price, qty, image);

          const carrito = Carrito.fromStorage();
          carrito.addItem(item);

          // Sincronizar subtotal/total y refrescar UI
          try {
            await syncWithServer(carrito.products);
          } catch (e) {}

          // Actualizar modal del header y abrir modal
          updateCart();
          const cartModal = document.querySelector('.cart-modal');
          const flexContainer = document.querySelector('.flex-container');
          cartModal?.classList.add('open');
          flexContainer?.classList.add('opacity');
          hideLoading();
          showToast('Producto agregado al carrito', 'success');
        });
      }
    });
  </script>

{% endblock %}
